<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Форма обратной связи</title>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
}

/* Кнопка открытия формы */
#openFeedback {
    display: block;
    margin: 150px auto;
    padding: 15px 30px;
    font-size: 18px;
    background: #0ea5a4;
    color: #fff;
    border: none;
    border-radius: 10px;
    cursor: pointer;
}

/* затемнение фона */
.popup-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
}
.popup-bg.open {
    display: flex;
}

/* окно формы */
.popup-content {
    background: white;
    padding: 25px;
    width: 90%;
    max-width: 400px;
    max-height: 95vh;
    overflow: auto;
    border-radius: 10px;
}
.popup-content h2 {
    text-align: center;
}
.popup-content input,
.popup-content textarea {
    width: 100%;
    padding: 10px;
    margin: 8px 0;
    box-sizing: border-box;
}
.popup-content textarea { height: 100px; resize: none; }

/* чекбокс */
.checkbox-area { text-align: center; margin: 10px 0; }

/* кнопки */
.buttons { text-align: center; margin-top: 15px; }
.buttons button { margin: 5px; padding: 10px 18px; cursor: pointer; }
#cancelBtn { background: #ddd; border: 1px solid #bbb; }

/* глобальное сообщение */
#globalMessage {
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4caf50;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    display: none;
    z-index: 4000;
    font-size: 16px;
}
#globalMessage.error { background: #e53935; }
</style>
</head>
<body>

<button id="openFeedback">Открыть форму</button>

<!-- глобальное сообщение -->
<div id="globalMessage"></div>

<!-- POPUP -->
<div id="popup" class="popup-bg">
    <div class="popup-content">
        <button id="closePopup" style="float:right;">✖</button>
        <h2>Обратная связь</h2>
        <form id="feedbackForm">
            <input id="fullname" name="fullname" placeholder="ФИО" required>
            <input id="email" type="email" name="email" placeholder="Email" required>
            <input id="phone" name="phone" placeholder="Телефон" required>
            <input id="org" name="organization" placeholder="Организация" required>
            <textarea id="message" name="message" placeholder="Сообщение" required></textarea>
            <div class="checkbox-area">
                <label>
                    <input type="checkbox" id="consent" required>
                    Я согласен с обработкой персональных данных
                </label>
            </div>
            <div class="buttons">
                <button type="button" id="cancelBtn">Отменить</button>
                <button type="submit">Отправить</button>
            </div>
        </form>
    </div>
</div>

<script>
// Ваш Formcarry ID
const FORM_URL = "https://formcarry.com/s/DNrd1XjUsiT";

const popup = document.getElementById("popup");
const openBtn = document.getElementById("openFeedback");
const closeBtn = document.getElementById("closePopup");
const cancelBtn = document.getElementById("cancelBtn");
const form = document.getElementById("feedbackForm");
const globalMsg = document.getElementById("globalMessage");

const fields = {
    fullname: document.getElementById("fullname"),
    email: document.getElementById("email"),
    phone: document.getElementById("phone"),
    org: document.getElementById("org"),
    message: document.getElementById("message"),
    consent: document.getElementById("consent")
};

const STORAGE_KEY = "form_data";

/* Телефон только цифры и + */
fields.phone.addEventListener("input", () => {
    fields.phone.value = fields.phone.value.replace(/[^0-9+]/g, "");
});

/* Открыть форму */
openBtn.onclick = () => {
    popup.classList.add("open");
    document.body.style.overflow = "hidden";
    history.pushState({popup:true}, "", "/feedback");
    loadStorage();
};
/* Закрыть форму */
function closePopup(goBack = true){
    popup.classList.remove("open");
    document.body.style.overflow = "";
    if(goBack) history.back();
}

closeBtn.onclick = () => closePopup();
cancelBtn.onclick = () => closePopup();
popup.onclick = e => { if(e.target === popup) closePopup(); };
window.onpopstate = () => { if(popup.classList.contains("open")) closePopup(false); };

/* LocalStorage */
function saveStorage(){
    const d = {
        fullname: fields.fullname.value,
        email: fields.email.value,
        phone: fields.phone.value,
        org: fields.org.value,
        message: fields.message.value,
        consent: fields.consent.checked
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
}
function loadStorage(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const d = JSON.parse(raw);
    fields.fullname.value = d.fullname || "";
    fields.email.value = d.email || "";
    fields.phone.value = d.phone || "";
    fields.org.value = d.org || "";
    fields.message.value = d.message || "";
    fields.consent.checked = d.consent || false;
}
Object.values(fields).forEach(f=>{
    f.addEventListener("input", saveStorage);
    f.addEventListener("change", saveStorage);
});

/* Сообщение */
function showMessage(text, isError=false){
    globalMsg.textContent = text;
    globalMsg.className = isError ? "error" : "";
    globalMsg.style.display = "block";
    setTimeout(()=>{ globalMsg.style.display="none"; }, 3000);
}

/* Отправка формы */
form.addEventListener("submit", async (e)=>{
    e.preventDefault();

    const fd = new FormData();
    fd.append("fullname", fields.fullname.value);
    fd.append("email", fields.email.value);
    fd.append("phone", fields.phone.value);
    fd.append("organization", fields.org.value);
    fd.append("message", fields.message.value);
    fd.append("consent", fields.consent.checked ? "yes" : "no");

    try{
        await fetch(FORM_URL, { method:"POST", body:fd });

        closePopup();
        form.reset();
        localStorage.removeItem(STORAGE_KEY);
        showMessage("Сообщение успешно отправлено!");
    }
    catch(err){
        closePopup();
        showMessage("Ошибка соединения!", true);
    }
});
</script>
</body>
</html>